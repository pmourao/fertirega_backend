{
  "entityType": "WIDGET_TYPE",
  "entity": {
    "tenantId": null,
    "bundleAlias": "fertirega_widgets",
    "typeAlias": "fertirega_valvecontrol_1",
    "alias": null,
    "title": "FertiRega Valve 1 Control",
    "image": null,
    "description": "Toggle switch control for Valve 1 with ChirpStack HTTP API",
    "descriptor": {
      "type": "RPC",
      "sizeX": 4,
      "sizeY": 3,
      "resources": [],
      "templateHtml": "<div class=\"valve-control-container\">\n  <div class=\"valve-header\">\n    <h3>Valve 1</h3>\n    <span class=\"valve-status\" ng-class=\"{'valve-open': valveStatus === 1, 'valve-closed': valveStatus === 0}\">{{valveStatusText}}</span>\n  </div>\n  <div class=\"switch-container\">\n    <label class=\"switch\">\n      <input type=\"checkbox\" ng-model=\"valveChecked\" ng-change=\"toggleValve()\">\n      <span class=\"slider round\"></span>\n    </label>\n  </div>\n  <div class=\"valve-info\">\n    <p>Last Updated: {{lastUpdate | date:'short'}}</p>\n  </div>\n</div>",
      "templateCss": ".valve-control-container {\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  padding: 20px;\n  background: #fff;\n  border-radius: 8px;\n  box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n  height: 100%;\n}\n\n.valve-header {\n  width: 100%;\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  margin-bottom: 20px;\n}\n\n.valve-header h3 {\n  margin: 0;\n  font-size: 18px;\n  font-weight: 500;\n  color: #333;\n}\n\n.valve-status {\n  padding: 4px 12px;\n  border-radius: 12px;\n  font-size: 12px;\n  font-weight: 500;\n}\n\n.valve-open {\n  background: #4caf50;\n  color: white;\n}\n\n.valve-closed {\n  background: #9e9e9e;\n  color: white;\n}\n\n.switch-container {\n  margin: 20px 0;\n}\n\n.switch {\n  position: relative;\n  display: inline-block;\n  width: 80px;\n  height: 40px;\n}\n\n.switch input {\n  opacity: 0;\n  width: 0;\n  height: 0;\n}\n\n.slider {\n  position: absolute;\n  cursor: pointer;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background-color: #ccc;\n  transition: .4s;\n}\n\n.slider:before {\n  position: absolute;\n  content: \"\";\n  height: 32px;\n  width: 32px;\n  left: 4px;\n  bottom: 4px;\n  background-color: white;\n  transition: .4s;\n}\n\ninput:checked + .slider {\n  background-color: #4caf50;\n}\n\ninput:checked + .slider:before {\n  transform: translateX(40px);\n}\n\n.slider.round {\n  border-radius: 40px;\n}\n\n.slider.round:before {\n  border-radius: 50%;\n}\n\n.valve-info {\n  margin-top: 20px;\n  text-align: center;\n  color: #666;\n  font-size: 12px;\n}",
      "controllerScript": "self.onInit = function() {\n    self.ctx.$scope.valveStatus = 0;\n    self.ctx.$scope.valveChecked = false;\n    self.ctx.$scope.valveStatusText = 'Closed';\n    self.ctx.$scope.lastUpdate = new Date();\n    \n    self.ctx.defaultSubscription.subscribe();\n    \n    self.ctx.$scope.toggleValve = function() {\n        var action = self.ctx.$scope.valveChecked ? 1 : 0;\n        var actionText = action === 1 ? 'open' : 'close';\n        \n        var deviceName = self.ctx.defaultSubscription.entityName;\n        var devEui = self.ctx.defaultSubscription.entityId.id;\n        \n        if (self.ctx.datasources && self.ctx.datasources[0] && self.ctx.datasources[0].entity) {\n            var entity = self.ctx.datasources[0].entity;\n            if (entity.name && entity.name.startsWith('eui-')) {\n                devEui = entity.name.replace('eui-', '');\n            }\n        }\n        \n        var valve = 1; // Valve 1\n        var buffer = [valve, action];\n        var base64 = btoa(String.fromCharCode.apply(null, buffer));\n        \n        var payload = {\n            queueItem: {\n                confirmed: true,\n                data: base64,\n                fPort: 2\n            }\n        };\n        \n        var url = 'http://100.92.66.20:8080/api/devices/' + devEui + '/queue';\n        \n        self.ctx.http.post(url, payload, {\n            headers: {\n                'Content-Type': 'application/json',\n                'Grpc-Metadata-Authorization': 'Bearer YOUR_API_KEY_HERE'\n            }\n        }).subscribe(\n            function(response) {\n                self.ctx.$scope.valveStatus = action;\n                self.ctx.$scope.valveStatusText = action === 1 ? 'Open' : 'Closed';\n                self.ctx.$scope.lastUpdate = new Date();\n                self.ctx.showSuccessToast('Valve 1 command sent: ' + actionText);\n            },\n            function(error) {\n                self.ctx.$scope.valveChecked = !self.ctx.$scope.valveChecked;\n                self.ctx.showErrorToast('Failed to send valve command: ' + error.message);\n            }\n        );\n    };\n};\n\nself.onDataUpdated = function() {\n    if (self.ctx.data && self.ctx.data.length > 0) {\n        var data = self.ctx.data[0];\n        if (data.data && data.data.length > 0) {\n            var latestData = data.data[0];\n            if (latestData[1] !== undefined) {\n                self.ctx.$scope.valveStatus = latestData[1];\n                self.ctx.$scope.valveChecked = latestData[1] === 1;\n                self.ctx.$scope.valveStatusText = latestData[1] === 1 ? 'Open' : 'Closed';\n                self.ctx.$scope.lastUpdate = new Date(latestData[0]);\n                self.ctx.detectChanges();\n            }\n        }\n    }\n};\n\nself.onDestroy = function() {\n};",
      "settingsSchema": "{}",
      "dataKeySettingsSchema": "{}",
      "defaultConfig": "{}"
    }
  }
}